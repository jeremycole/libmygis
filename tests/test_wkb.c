/*
    Copyright (c) 2004-2005, Jeremy Cole and others

    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 2.1 of the License, or (at your option) any later version.

    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this library; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/

#include "mygis.h"
#include "geometry.h"
#include "wkb/wkb_priv.h"
#include "wkt/wkt.h"

#include <stdio.h>
#include <stdlib.h>

/* POINT(1 1) */
static char point_1[21] = {
  0x01, /* byte order */
  0x01, 0x00, 0x00, 0x00,  /* type: 1, point */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F
};

/* POINT(50.235 -42.456) */
static char point_2[21] = { 
  0x01, /* byte order */
  0x01, 0x00, 0x00, 0x00, /* type: 1, point */
  0xAE, 0x47, 0xE1, 0x7A, 0x14, 0x1E, 0x49, 0x40,
  0xEE, 0x7C, 0x3F, 0x35, 0x5E, 0x3A, 0x45, 0xC0
};

/* LINESTRING(1 1, 50.235 -42.456) */
static char linestring_1[41] = {
  0x01, /* byte order */
  0x02, 0x00, 0x00, 0x00, /* type: 2, linestring */
  0x02, 0x00, 0x00, 0x00, /* length: 2 points */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0xAE, 0x47, 0xE1, 0x7A, 0x14, 0x1E, 0x49, 0x40,
  0xEE, 0x7C, 0x3F, 0x35, 0x5E, 0x3A, 0x45, 0xC0
};

/* POLYGON((1 1, -1 1, -1 -1, 1 -1, 1 1)) */
static char polygon_1[93] = {
  0x01, /* byte order */
  0x03, 0x00, 0x00, 0x00, /* type: 3, polygon */
  0x01, 0x00, 0x00, 0x00, /* linearrings: 1 */
  0x05, 0x00, 0x00, 0x00, /* length: 5 points */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xBF,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xBF,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xBF,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xBF,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x3F
};

/* MULTIPOLYGON(((10 10, 10 20, 20 20, 20 10, 10 10), (12 12, 14 12, 14 14, 12 14, 12 12)), ((20 20, 20 30, 30 30, 30 20, 20 20))) */

static char multipolygon_1[279] = {
  0x01, /* byte order */
  0x06, 0x00, 0x00, 0x00, /* type: 6, multipolygon */
  0x02, 0x00, 0x00, 0x00, /* polygons: 2 */

  /* polygon 0 */
  0x01,
  0x03, 0x00, 0x00, 0x00, /* type: 3, polygon */
  0x02, 0x00, 0x00, 0x00, /* linearrings: 2 */
  /* linearring 0 */
  0x05, 0x00, 0x00, 0x00, /* length: 5 points */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
  /* linearring 1 */
  0x05, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
  
  /* polygon 1 */
  0x01, 
  0x03, 0x00, 0x00, 0x00,
  0x01, 0x00, 0x00, 0x00,
  /* linearring 0 */
  0x05, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40
};

int main(int argc, char **argv) {
  WKB *wkb;
  GEOMETRY *geo;
  char *test[7] = {
    point_1,
    point_2,
    linestring_1,
    polygon_1,
    multipolygon_1,
    NULL
  };
  int size[7] = { 21, 21, 41, 93, 279, 0 };  
  char **p;
  int *s;
  char *w;
  char *i, *j;
  int x;
  uint32 est_size;

  DBUG_ENTER("main");
  DBUG_PROCESS(argv[0]);
  DBUG_PUSH("d:t");

  wkb = wkb_init(0);
  for(p=test, s=size; *p; p++, s++) {
    if(wkb_load(wkb, *p, *s, WKB_F_DUPE) != 0) {
      fprintf(stderr, "Couldn't load WKB.\n");
      exit(1);
    }
    while( (geo = wkb_read_next(wkb)) ) {
      est_size= wkb_size(geo);
      if(est_size != *s)
        printf("size estimation is wrong!  should be %i, is %i\n", *s, est_size);
      printf("wkb size = %i\n", wkb_size(geo));
      w = wkb_write(geo, NULL);
      if(!memcmp(*p, w, *s)) {
        printf("match!\n");
      } else {
        printf("no match!\n");
        for(i = *p, j = w, x=0; x < *s; i++, j++, x++) {
          printf("  %02i: p = %02x, w = %02x\n", x, *((char *)i), *((char *)j));
        }
      }
      free(w);
      geometry_dump(geo, 5);
      geometry_free(geo);
    };
  };
  wkb_free(wkb);

  DBUG_RETURN(0);
}
